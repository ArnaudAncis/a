\documentclass{../ucll-slides}
\usepackage{../pvm}
\usepackage{emerald}
\usepackage[T1]{fontenc}

\usetikzlibrary{shadows}

\title{Declarations and Definitions}
\author{Fr\'ed\'eric Vogels}



\begin{document}

\begin{frame}
  \titlepage
\end{frame}


\begin{frame}
  \frametitle{Problem: Fitting Everything in RAM}
  \begin{itemize}
    \item Compiling requires a lot of RAM
    \item Not only did computers have little RAM\dots
    \item \dots they had very little RAM
    \item Cannot even keep one entire source file and corresponding data in RAM
    \item They wanted single pass compilation
      \begin{itemize}
        \item Read in a bit of code
        \item Check the code for correctness (syntax, types, \dots)
        \item Produce assembly code
        \item Forget as much as possible (freeing up RAM)
        \item Proceed to next bit of code
      \end{itemize}
  \end{itemize}
\end{frame}

\begin{frame}
  \frametitle{Problem: Forward References}
  \code[width=5cm]{forward-reference.cpp}
  \begin{itemize}
    \item Cannot compile {\tt foo} without knowing {\tt bar}'s type signature
          \begin{itemize}
            \item Is it true that {\tt bar} does not require arguments?
            \item Is it true that {\tt bar} returns a {\tt double}?
          \end{itemize}
    \item Definition of {\tt bar} only appears later
  \end{itemize}
\end{frame}

\begin{frame}
  \frametitle{Solution}
  \begin{center}
    Put {\tt bar}'s definition before {\tt foo}'s
  \end{center}
  \vskip5mm
  \code[width=5cm]{forward-reference-solution.cpp}
\end{frame}

\begin{frame}
  \frametitle{Problem: Cyclical References}
  \begin{overprint}
    \onslide<1>
    \code[width=5cm]{cyclical.cpp}
    \onslide<2>
    \code[width=5cm]{cyclical2.cpp}
  \end{overprint}
  \begin{itemize}
    \item No ordering possible
    \item What to do now?
  \end{itemize}
\end{frame}

\begin{frame}
  \frametitle{Forward Declarations}
  \code[width=5cm]{cyclical.cpp}
  \begin{itemize}
    \item What does compiler need to compile {\tt foo}?
          \begin{itemize}
            \item {\tt bar}'s arity (number of parameters)
            \item Parameter types
            \item Return type
          \end{itemize}
    \item What does compiler \emph{not} need to compile {\tt foo}?
          \begin{itemize}
            \item Function body
          \end{itemize}
  \end{itemize}
\end{frame}

\begin{frame}
  \frametitle{Forward Declarations}
  \begin{overprint}
    \onslide<1>
    \code[width=7cm]{forward-declaration.cpp}
    \onslide<2>
    \code[width=7cm]{forward-declaration2.cpp}
    \onslide<3>
    \code[width=7cm]{forward-declaration3.cpp}
  \end{overprint}
  \begin{itemize}
    \item Forward declaration: provide the compiler with minimal though sufficient information
    \item For a function: name + parameter types + return type
  \end{itemize}
\end{frame}

\begin{frame}
  \frametitle{Declarations and Definitions}
  \begin{itemize}
    \item A declaration provides \emph{partial} information
    \item A definition provides \emph{all} information
    \item All that is \emph{declared} should be \emph{defined} at some later point
    \item A declaration is a promise
  \end{itemize}
  \begin{center} \it
    ``I'll fill you in on the details later, but this is a quick summary''
  \end{center}
\end{frame}

\begin{frame}
  \frametitle{Declarations and Definitions}
  \code{class.cpp}
  Which information is necessary?
  \begin{itemize}
    \item Existence of type {\tt Person}
    \item Type signature of constructor
    \item Size of {\tt Person} (how much memory needs to be allocated?)
  \end{itemize}
\end{frame}

\begin{frame}
  \frametitle{Declarations and Definitions}
  \code{class-with-decl.cpp}
\end{frame}

\begin{frame}
  \frametitle{Forward Declarations}
  \code{class2.cpp}
  Which information is necessary?
  \begin{itemize}
    \item Existence of type {\tt Person}
    \item Nothing more
  \end{itemize}
\end{frame}

\begin{frame}
  \frametitle{Declarations and Definitions}
  \code{class2-with-decl.cpp}
\end{frame}

\begin{frame}
  \frametitle{Declarations and Definitions}
  \begin{itemize}
    \item Rules for classes are more complex
    \item Multiple possible ways to declare classes
    \item Provide different amount of information
    \item Once you define internals of a class, you must list them all
    \item I.e.\ you are not allowed to add fields/methods afterwards
    \item Method bodies can (often) be deferred
  \end{itemize}
\end{frame}

\begin{frame}
  \frametitle{Example}
  \begin{overprint}
    \onslide<1>
    \code[font size=\small]{class-example.cpp}
    \onslide<2>
    \code[font size=\small]{class-example2.cpp}
    \onslide<3>
    \code[font size=\small]{class-example3.cpp}
    \onslide<4>
    \code[font size=\small]{class-example4.cpp}
  \end{overprint}
\end{frame}

\begin{frame}
  \frametitle{Exceptions}
  \begin{itemize}
    \item Member functions can refer to other member functions
          from the same class that have not been declared yet
  \end{itemize}
  \code[width=8cm]{class-no-decl.cpp}
\end{frame}

\begin{frame}
  \frametitle{Exceptions}
  \begin{itemize}
    \item Some weird rules
    \item Code below fails because compiler expects 0 parameters
    \item Solution: use {\tt ::foo(5)}
  \end{itemize}
  \code[width=8cm]{class-weird.cpp}
\end{frame}

% \begin{frame}
%   \frametitle{Problem Statement}
%   \begin{itemize}
%     \item Codebase can become very large
%     \item Compilers need to be able to handle such large codebases
%     \item Computers didn't have a lot of RAM
%     \item Could not fit thousands/millions of lines of code in RAM
%   \end{itemize}
%   \vskip5mm
%   \structure{Solution}
%   \begin{itemize}
%     \item Divide the codebase in small units
%     \item ``Compilation units'' (CUs): {\tt .cpp} files
%     \item Compile each unit separately
%     \item Link results together
%   \end{itemize}
% \end{frame}

% \begin{frame}
%   \frametitle{Build Steps}

%   \begin{center}
%     \begin{tikzpicture}[cpp/.style={draw,thick,drop shadow,fill=white,minimum width=2cm,minimum height=.75cm},
%                         obj/.style={draw,thick,drop shadow,fill=white,minimum width=2cm,minimum height=.75cm},
%                         exe/.style={draw,thick,drop shadow,fill=white,minimum width=2cm,minimum height=.75cm},
%                         compile/.style={-latex,thick},
%                         compile arc/.style={above,midway,font=\tiny},
%                         link/.style={-latex,thick},
%                         link arc/.style={above,midway,font=\tiny,sloped}]
%       \node[cpp] (a cpp) at (0,4) {A.cpp};
%       \node[cpp] (b cpp) at (0,2) {B.cpp};
%       \node[cpp] (c cpp) at (0,0) {C.cpp};

%       \visible<2->{
%         \node[obj] (a obj) at (4,4) {A.obj};
%       }

%       \visible<2>{
%         \draw[compile] (a cpp) -- (a obj) node[compile arc] {compile};
%       }

%       \visible<3->{
%         \node[obj] (b obj) at (4,2) {B.obj};
%       }

%       \visible<3>{
%         \draw[compile] (b cpp) -- (b obj) node[compile arc] {compile};
%       }

%       \visible<4->{
%         \node[obj] (c obj) at (4,0) {C.obj};
%       }

%       \visible<4>{
%         \draw[compile] (c cpp) -- (c obj) node[compile arc] {compile};
%       }
      
%       \visible<5->{
%         \node[exe] (exe) at (8,2) {app.exe};
%       }
      
%       \visible<5>{
%         \node[exe] (exe) at (8,2) {app.exe};
%         \draw[link] (a obj) -- (exe) node[link arc] {link};
%         \draw[link] (b obj) -- (exe) node[link arc] {link};
%         \draw[link] (c obj) -- (exe) node[link arc] {link};
%       }
%     \end{tikzpicture}
%   \end{center}
% \end{frame}

% \begin{frame}
%   \frametitle{Problem: Interdependent Compilation Units}
%   \begin{itemize}
%     \item Say code in CU1 contains call to some function {\tt foo}
%     \item Compiler wants to type-check
%     \item Compiler needs to find definition for {\tt foo}
%     \item In which CU does it reside? No idea!
%     \item Visit each CU looking for {\tt foo}?
%     \item Repeat this process for every external dependency?
%     \item Prohibitive cost
%     \item Cannot cache things, requires too much RAM
%   \end{itemize}
% \end{frame}


% Header files!
% Include guards

\end{document}